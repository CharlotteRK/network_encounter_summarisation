\subsection{Data Flow}

\subsubsection{Input and Processing}
Multiple formats can be processed using the command line tool that has been developed during this project. Processing multiple input formats allows for  Initially only TCPdump was considered since it is the format with the most redundant information, and therefore on which summarisation would give the greatest benefit. The tool took input in the form of binary PCAP files, however this was then extended to allow syslog formats to be used as input. The output produced is in an identical format regardless of the input type. Using a consistent output format regardless of the input format is important as it means that researchers can treat data collected from multiple sources similarly. Data flow for the two input types is nearly identical and is detailed in figure \ref{fig:df_dia}.\newline
\begin{figure}[h]
    \centering
    \includegraphics[width=0.7\textwidth]{df_diagram.png}
    \caption{This figure shows the flow of data through the system, including temporary file stores and input/output to each processing stage.}
    \label{fig:df_dia}
\end{figure}

The first stage of processing is to extract associations between devices and access points from the raw input. These associations will later be compared with each other to determine encounters between devices, these comparisons are expensive and so it is important that as much information as possible is removed before they are made. The intermediate format used to store association information is  a comma separated value file. MatLab is used in the second stage of processing and has a very good interface for reading character delimited text files such as CSV format. The intermediate format has fields of source id, destination id, start time, end time, and AP flag. The AP flag is set to 1 only if the destination address of the association can be identified as an access point. Methods used to identify access points are discussed later in this report.

TCPdump output PCAP files are very strictly structured. This allows for them to be processed without any additional information from the user. However the initial parsing is expensive with respect to time since so much information is contained within them. In comparison to this, syslog files are relatively quick to parse for associations. Syslog formats vary according to the preferences of the network administrator, so the user must include a configuration file to specify the format used. Details such as defining features of association end points and the format of device identification values need to be given to the tool before it can extract associations. A timestamp in seconds must be included for key lines in the syslog file for it to be parsed by this tool successfully. The expected format of a configuration file for use with syslog is detailed in figure \ref{fig:JSON_config}. Several configuration file formats were considered for use here, with final choice being to use a YAML structure. YAML allows more complex nested structures than other similar formats while staying more human readable than alternatives such as JSON.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.9\textwidth]{conf.png}
    \caption{This figure shows a YAML configuration file used for the processing of the dartmouth/campus Cisco syslog files. The fields have been colour coded for readability and descriptions of the fields have been given. The colour does not reflect any formatting of the actual configuration file. It should be noted that although the regular expressions are the same in both the start and end sections of the configuration file shown, this is not a requirement.}
    \label{fig:JSON_config}
\end{figure}

An example of how the configuration shown in figure \ref{fig:JSON_config} is applied to a syslog file \cite{dartmouthcampus2009syslog} is shown in figure \ref{fig:cisco_syslog} using the same colour scheme. This is a simple example and more complex configurations may include multiple start and/or end blocks (allowing multiple differently structures lines to be recognised as the start or end of an association). Multiple conditions could be used within each start and/or end block, all of these would then need to be satisfied for the line to be recognised as matching that block. 
\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{cisco_coloured.png}
    \caption{This figure shows a two line extract of the dartmouth/campus Cisco syslog files \cite{dartmouthcampus2009syslog}. The information used by the summarisation tool is colour coded matching the parts of figure \ref{fig:JSON_config} which identify it. The first line shown matches the conditions for the end of an association, and the second line matches the conditions for the beginning of an association.}
    \label{fig:cisco_syslog}
\end{figure}
\newline
Tying together the components of this data flow is a BASH script, this can be configured using flags at run time. The BASH script allows for data to be piped between some processing elements, and for temporary files to be shared between processing stages. Temporary files are used for storing associations in the intermediate stages, these files are then read by the MatLab script which compares associations to find encounters. A final output file is then given either as a comma separated values file or a ONE simulator events trace, and all temporary files are cleaned up. 
% Optional levels of abstraction??

% explain fields chosen
%   - how is encounter data used in external studies?
% Data flow diagrams
% BASH scripting

\subsubsection{Summary Output}
The final output can be given in one of two formats, the first (default output) specifies the endpoints of encounters, the average time of encounters between the given end points, and the number of encounters found between the given end points. Only one entry in the CSV file is present for each unordered pair of end points. A small section of an output summary is shown in figure \ref{fig:output}, it has been colour coded for ease of reading.\newline
\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{Output_Example_Coloured.png}
    \caption{This figure shows a small section of an output file produced by the summarisation tool developed during this project. The columns have been colour coded for readability, but this does not reflect any formatting of the output CSV.}
    \label{fig:output}
\end{figure}

The data sets which I am using in this project have in the past frequently been used for research into mobility and encounter patterns between users \cite{Scellato2011} \cite{Xiao2014} \cite{Hsu2010} \cite{Musolesi2009} \cite{Kosta2014} \cite{Kumar2009} \cite{Wei2013}. To maximise the usefulness of this project it is intended that the output from this  summarisation tool will be able to help in identifying whether a dataset is appropriate for use in mobility research, and to provide a standard format between multiple input formats which can be used for onward processing.

The second format which can be used for output is an events file compatible for use with the ONE simulator \cite{Keranen2009}. The ONE simulator is a commonly used tool in mobility research, it is a simulation environment which can show interactions in a network using its GUI, or produce a variety of reports (including some regarding node mobility). Real-world event data can be used in simulations using the ONE simulator. Additional input may be necessary in some applications, such as geographical information about the environment in which the network event were collected, or connection speeds and ranges. This additional information is out of the scope of this project, in the examples given in this document the minimum additional information is used for simulations (mostly settings are maintained as they were in the default settings configuration from the installation source directory). Figure \ref{fig:events_out} shows an extract of this event trace output.
\begin{figure}[h]
    \centerline{\includegraphics[width=0.9\textwidth]{events_output.png}}
    \caption{This figure shows a small section of an output file produced by the summarisation tool developed during this project. Each field has been colour coded and explained alongside the extract.Only events of type `CONN' are recorded in the events traces output by this summarisation tool. `CONN' events can have subtype `up' for the beginning of a connection (or in the terms used in this paper, the beginning of an association) or `down' for the end of a connection.}
    \label{fig:events_out}
\end{figure}

A variant on the events file format which maintains the original timestamps and device identifications is also provided, the use of which is discussed in section \ref{section:merge}.

\subsection{Associations} 

\begin{figure}[h]
    \centerline{\includegraphics[width=1.2\textwidth]{hardware_to_assoc.png}}
    \caption{This diagram shows a high level representation of two associations and the corresponding network connections which would cause them. If these two associations were active during the same period of time, an encounter would exist between the two mobile devices.}
    \label{fig:high_level_dia}
\end{figure}
In this project two identifiable devices are considered to be associated with each other for any period of time during which they are exchanging data, a graphical representation of this is shown in figure \ref{fig:high_level_dia}. Due to the definition of encounters (explained in more detail is section \ref{section:encounters}) in this context only associations between one mobile node and one access point are relevant. In addition a device might only be identified as an access point after several packets have been exchanged with it, it is therefore important that all associations are detected and recorded until a full list of access points is available.
%(what? why?)
\subsubsection{Identifying Access Points}
Access points need to be determined as only the associations with access points are needed in the later stage of this processing. Access points may be identified from tcpdump traces by reading the flags in the TCP header of the packets sent to them. The SYN control flag of TCP packets is checked, when it is set to true the destination of the packet can be determined to be an access point. Once a packet is identified as an access point a flag is set by it in the intermediate temporary associations CSV file. This flag is used in later processing to remove all irrelevant associations from the data and to create a record of all detected access points in the network. By removing irrelevant associations the time efficiency of the summarisation is increased, as fewer comparisons have to be made in order to identify all encounters. A full list of access points must be completed before associations are matched into encounters; if the access point list was built as the associations were searched some encounters early in the data may be missed.\\\\
This method of detecting access points means that access points which do not exchange TCP data with any mobile nodes will not be detected, and therefore encounters which occur through them will not be recorded. It is unlikely for a network trace running over a significant period of time that an access point will associate with multiple devices and yet not transfer any TCP packets with them, this means that any access points not detected by this method are extremely unlikely to have facilitated any encounters.\\\\
When parsing syslog files the location and format of the access points identifications should be specified in the configuration file. As all association and disassociation messages in a syslog file should contain an access point, all lines in the intermediate temporary associations CSV file created from a syslog input will be set as true. Despite this potentially seeming to be a waste of time to set all flags to true, it is necessary to maintain the intermediate format so that the next stage of processing can be completed using the same method regardless of initial input format.
Some input files showed hundreds of access points being detected. This is likely due to each physical access point having many separate MAC addresses with which it will communicate. There is no way to identify which addresses correspond to the same physical access point without a record to match them against. Since such a record is not available for the CRAWDAD dartmouth/campus data (and likely wouldn't be immediately available for most network traces someone might want to use with this summarisation tool) the decision has been made to only consider an encounter to have taken place is both mobile devices are connected to the same access point MAC address. This is similar to saying that each MAC address being used by a physical access point has been considered as a separate device.
\subsubsection{Initiation} 
% (what? why?)
A design decision needed to be made regarding the conditions that would specify the beginning of an association between two devices. This is an important part of the design of this system since it defines the meaning of an association, and therefore the meaning of an encounter in the final output of the system.\\\\
Identifying association request packets could be used as a method of identifying the beginning of associations. However it has been found during development that often two devices are in contact and transmit data between themselves without ever sending an association request packet. Since an association is open during the period of time which two devices are communicating, a simplistic way of finding the start of an association may be the timestamp of the first packet transmitted between two identifiable devices.\\\\
It was decided that with a tcpdump input, the initiation of an association would be triggered by a packet being transmitted between two devices which do not currently have an ongoing association. While an association is ongoing a transmission between the endpoints will not trigger a new association. If only one packet is transmitted between the endpoints within the timeout period it is not considered as an association. This is because it may have been a message sent to an unavailable destination, and in such a situation no contact is made between the source and destination devices.\\\\
Syslog files may have varying structures so a way to identify the location of key information within the file is needed. Therefore, when a syslog file is used as input the configuration file should contain conditions for a message to define the start of an association. These condition will have to be checked against each line in the syslog file to find the beginning of each association. The endpoints of the association should also have their identifications location and format within the line described in the configuration file. In the case that a configuration file specifies conditions which are ambiguous (for instance causing multiple matches for a devices identification within the line) or too strict (for instance not finding any association start messages or not being able to identify any device identifications which match the conditions given int he configuration file) then the user should be warned. Such a case my occur if the configuration file has been mistyped or the wrong configuration file is being used, however it could also be triggered in a case with unexpected data such as no associations occurring. By warning the user it gives them the opportunity to update the configuration file if necessary, but will not prevent the tool being run using a configuration file which triggers the warning.
% options
% decision

\subsubsection{End of Association} 
% (what? why?)
In some cases a specific message or packet type may be found which determines that a device has moved out of range of an access point. This would mean that the association between that device and access point has come to an end. However, in the pcap traces which I have been focusing on it seems common that the end of an association is not explicitly signalled in the trace. In these cases another method of detecting an appropriate time for ending an association is needed. \\\\
Research into work already done with the CRAWDAD data \cite{kotz2002} \cite{henderson2004} shows that a timeout of thirty minutes has previously been considered to be adequate for determining the end of a session, leading to a deauthentication of the device. This timeout length will therefore be use in this project to catch the end of associations when no explicit disassociation is found. 
When working with a tcpdump input, if no packets are transmitted between two associated devices for a thirty minute period the end of the association will be recorded using the timestamp of the most recent packet transmitted between them. When a syslog input is being used, conditions which identify a message showing the end of an association should be specified in the configuration file similarly to how they were specified for the beginning of an association.
% research
% decision
% alternatives? why not?

\subsection{Encounters} 
% (what? why?)
\label{section:encounters}
\begin{figure}[h]
    \centerline{\includegraphics[width=0.8\textwidth]{assoc_to_enc.png}}
    \caption{This diagram shows a example of how associations may be matched together to find encounters, and how the encounters may then be output in both available formats. Timestamps here are left as Unix epoch times since only a fragment of data is shown. In actuality times would be converted to an offset (in seconds) from the beginning of the first encounter found.}
    \label{fig:assoc_to_enc}
\end{figure}
Two devices are said to encounter each other when they are within communication ranger, encounters in this project have a resolution of seconds, but can last as long as the tcpdump or syslog trace records traffic for. Devices are assumed to be in transmission range of each other for the duration of time when they are associated with the same access point. Encounters between devices are considered to begin at the earliest time where both devices are connected to the same access point, and to end as soon as one of the two devices disassociates from the access point. An example of how an encounter would be found from a set of associations is shown in figure \ref{fig:assoc_to_enc}. To find details of an encounter it is necessary to know which device identifications belong to access points, as these will act to facilitate encounters rather than being the end points. The associations will need to be matched together by considering the time overlap in the case that they both use the same access point.\\\\
It is likely that these matches will need to be found in a large set of associations, over a long time period, and many access points. It will therefore be important for the implementation of this to be efficient. As previously mentioned, to maximise efficiency in this stage of processing all associations which definitely do not contribute to an encounter need to be eliminated from the data as soon as possible. This is achieved by removing all associations which do not include an access point as one end point as soon as a full list of access points has been identified.
% Encounters from associations
\subsection{Merging Summaries}
\label{section:merge}
In addition to the main summarisation of data, this tool also allows for the merging of multiple summaries into a single file of the same structure. By using the `merge' command when running the tool a directory of `.txt' or `.csv' files can be merged together. When encounters summaries (those of structure seen in figure \ref{fig:output}) are merged the output data is the same as if all of the initial network traces had been summarised together to begin with. However, the events output format (as seen in figure \ref{fig:events_out}) discards the real timestamps on the events and the real device identifiers. In the events format the time is seen relative to the beginning of the file and the identifiers are changed to be numerical (1 to the number of mobile devices). Due to these loses of information the event format output cannot be merged as is, however a summary output format is provided (selected by use of `events\_maintain\_identifiers' with the -t flag) which does not replace the device identifiers or timestamps, and is therefore friendly to the merging. When merging events files the output will be given with relative timestamps and numerical device identifications, the original values will not be kept after the merge.

The input directory (specified using the -i flag) should only contain one format of summary, if a mixture of encounters summaries and events traces is present then the tool will exit without producing the requested output file and will display an error to the user. If `.txt' or `.csv' files which are not in either summary output format are found in the input directory the tool will also display an error and exit without producing an output file.\\\\
The value of this feature is mainly due to the quadratic execution time at increasing association numbers (as discussed in section \ref{section:impl_stage3}). When a large input file is summarised it may be split into smaller input files and the resulting summaries merged back together resulting in a lower execution time for sufficiently high numbers of associations. For an input of size $N$ split into chunks of size $n$, the quadratic increase in time will be dependent on $n$, and a linear slow down is expected with respect to $N$. However, a faster execution time will only be observed in very large files due to the time taken to complete the merge, and the initialisation time needed for each chunk of processing. Associations would also be split at the boundaries of each input chunk, this effect may be minimised by choosing to split the input at times where the network is expected to be quietest.

The ability to merge summaries after processing sections of the input separately could lead into a distributed approach to handling large inputs, however such a distributed system has not been developed during this project. A system for deciding where to split files for maximum efficiency would need to be considered, as well as a method of splitting files which wouldn't cut associations over the boundary (or would detect such instances and fix the split associations).

\subsection{UI} % or lack of...
\subsubsection{Overview}
The tool produced by this project is intended to be used by researchers in fields such as network mobility and DTNs. It is therefore appropriate to assume that a command line UI is sufficient, as users will be familiar with using terminal applications. Spending time improving the efficiency and functionality of the tool is more important than developing graphical interface which can be used without experience of using the command line. In addition to the unnecessary nature of a graphical interface, a command line tool gives users the ability to script and to pipe, this may be essential for researchers working with large quantities of data and complex data flows.\\\\
When large datasets are used with the tool it may be the case that a significant amount of time is spent processing the data. Due to this it is important that the UI keeps the user updated on the progress made. This should allow a user to know that the tool is working, and if possible to show them how far through the process the tool is. It should be expected that a large dataset may take several minutes (or even hours) to process, but to minimise user frustration this should be made transparent. By keeping the user informed of the amount of progress made in real-time the user is less likely to believe something has gone wrong and terminate the process while progress is in reality being made.\\\\
Ideally the tools UI should output a brief description of the stage of processing it is at, a progress bar which is updated in real time, and a small amount of additional information (such as directory names which are being used) so that the user knows a mistake hasn't been made. Hopefully this will allow users to avoid mistakes such as running a process for several minutes only to find the wrong input was used.\\\\
\subsubsection{Runtime Options}
The tool is run by using a BASH script `summarise.sh'. When a user runs the script they must use either the `merge' or `summary' command and have several optional arguments to use for setting various runtime parameters. 
\\\\
Commands:
\begin{itemize}
    \item merge: used to combine all of the summary files in the input directory. An error will be thrown if the input directory contains .txt or .csv files which are not in the expected format. The output given will be in the same format as the input summaries. Only the -i and -o options will effect this command.
    \item summary: used to summarise tcpdump or syslog traces into one of the avaliable summary output formats. The -c option will only be used if the -f option is set to `syslog'.
\end{itemize}
Options:
\begin{itemize}
    \item -f $<<$input\_format$>>$ is used to specify the format of the input files. Currently only `syslog' and `tcpdump' are valid formats to use with this flag, and if the flag is not used then the tool assumes a default format of tcpdump pcap output.
    \item -i $<<$input\_dir$>>$ is used to specify an input directory. This is the directory which will be searched for appropriate input files for the tool, if the -i flag is not set then the current directory is used as a default.
    \item -o $<<$output\_file$>>$ is used to specify a path for the output file. If the flag is not used then the script will create a file in the current directory with name of format YYYY-MM-DD\_hh-mm-ss\_summary.csv (with the current date and time used where appropriate).
    \item -c $<<$config\_file$>>$ is used to specify a configuration file for use during processing. If a configuration file is not required to process input of the specified format then the configuration file will be ignored, but a warning will be output to terminal. If no configuration file is specified when the format demands it, an error message is output to stderr and the script will exit immediately.
    \item -t $<<$output\_type$>>$ is used to specify which output format of summary to produce. Currently only `events' or `encounters' are valid output types to use here. By default if this flag is not used an encounter summary will be produced containing the average length and the frequency of encounters between each pair of mobile devices.
\end{itemize}
The structure of the command should be `./summarise $<$command$>$ $<$options$>$'.